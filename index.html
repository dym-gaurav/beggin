<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sentence Visualizer</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: black;
        color: white;
        overflow: hidden;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Quivert', Arial, sans-serif;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    @font-face {
        font-family: 'Quivert';
        src: url('quivert.ttf') format('truetype');
    }

    #visualizer-container {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-direction: column;
    }

    #sentence-display {
        font-size: 48px;
        max-width: 90%;
        line-height: 1.4;
        transition: color 0.2s ease;
    }

    #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: black;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        font-size: 24px;
    }

    #progress-bar {
        width: 60%;
        height: 20px;
        background-color: #444;
        margin-top: 20px;
        border-radius: 10px;
        overflow: hidden;
    }

    #progress-fill {
        width: 0%;
        height: 100%;
        background-color: #00ff00;
        transition: width 0.1s linear;
    }

    .hidden {
        display: none !important;
    }

    /* --- BUTTON STYLES --- */
    .control-button {
        position: fixed;
        bottom: 40px;
        padding: 12px 24px;
        background-color: rgba(255, 255, 255, 0.9);
        color: black;
        font-size: 20px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        z-index: 200;
        transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .control-button:hover {
        transform: scale(1.05);
        background-color: white;
    }

    #play-button {
        left: 40px;
    }

    #fullscreen-button {
        right: 40px;
    }
</style>
</head>
<body>
<div id="loading">
    <p>Loading audio and transcript...</p>
    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>
</div>

<!-- Control Buttons -->
<button id="play-button" class="control-button">Play</button>
<button id="fullscreen-button" class="control-button">Fullscreen</button>

<div id="visualizer-container">
    <div id="sentence-display"></div>
</div>

<script>
const sentenceDisplay = document.getElementById('sentence-display');
const loading = document.getElementById('loading');
const progressFill = document.getElementById('progress-fill');
const body = document.body;

const playButton = document.getElementById('play-button');
const fullscreenButton = document.getElementById('fullscreen-button');

const audio = new Audio('her.mp3');
let isPlaying = false;
let animationId = null;
let preparedSentences = [];
let lastWordIndex = -1;
let colorToggle = false;

// PLAY BUTTON (click once)
playButton.addEventListener('click', () => {
    if (isPlaying) return; // prevent multiple clicks
    playButton.classList.add('hidden');
    audio.play();
    isPlaying = true;
    updateDisplay();
});

// FULLSCREEN BUTTON (click once)
fullscreenButton.addEventListener('click', async () => {
    fullscreenButton.classList.add('hidden');
    if (!document.fullscreenElement) {
        await document.documentElement.requestFullscreen();
    }
});

// SPACEBAR toggles pause/play (optional)
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault();
        if (isPlaying) {
            audio.pause();
            isPlaying = false;
        } else {
            audio.play();
            isPlaying = true;
            updateDisplay();
        }
    }
});

// Initialize
async function init() {
    try {
        const response = await fetch('her.json');
        const sentences = await response.json();
        preparedSentences = sentences.map(entry => {
            const words = entry.sentence.split(' ');
            return {
                words: words,
                start: entry.start,
                end: entry.end,
                duration: entry.duration
            };
        });

        audio.addEventListener('progress', () => {
            if (audio.buffered.length > 0 && audio.duration > 0) {
                const percent = (audio.buffered.end(0) / audio.duration) * 100;
                progressFill.style.width = percent + '%';
            }
        });

        audio.addEventListener('canplaythrough', () => {
            loading.classList.add('hidden');
        });

        audio.addEventListener('error', () => {
            loading.innerHTML = '<p>Error loading audio. Please check if track.mp3 exists.</p>';
        });

        audio.load();

    } catch (error) {
        console.error('Error loading data:', error);
        loading.innerHTML = '<p>Error loading audio or transcript. Please check if track.mp3 and data.json exist.</p>';
    }
}

function updateDisplay() {
    if (!isPlaying) return;
    const currentTime = audio.currentTime;
    let currentSentence = null;
    let currentWordIndex = -1;

    for (const sentence of preparedSentences) {
        if (currentTime >= sentence.start && currentTime <= sentence.end) {
            currentSentence = sentence;
            const numWords = sentence.words.length;
            const wordDuration = sentence.duration / numWords;

            for (let i = 0; i < numWords; i++) {
                const wordStart = sentence.start + i * wordDuration;
                const wordEnd = wordStart + wordDuration;
                if (currentTime >= wordStart && currentTime <= wordEnd) {
                    currentWordIndex = i;
                    break;
                }
            }
            break;
        }
    }

    if (currentSentence && currentWordIndex >= 0) {
        if (currentWordIndex !== lastWordIndex) {
            colorToggle = !colorToggle;
            body.style.backgroundColor = colorToggle ? 'white' : 'black';
            sentenceDisplay.style.color = colorToggle ? 'black' : 'white';
            lastWordIndex = currentWordIndex;
        }
        const sentenceText = currentSentence.words.slice(0, currentWordIndex + 1).join(' ');
        sentenceDisplay.textContent = sentenceText;
    } else {
        sentenceDisplay.textContent = '';
    }

    animationId = requestAnimationFrame(updateDisplay);
}

init();
</script>
</body>
</html>
